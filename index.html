<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X(Twitter) 不具合報告</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
    <h1>X(Twitter) 不具合報告</h1>
    <button id="reportButton">不具合を報告</button>

    <div id="chartContainer">
        <canvas id="statusChart"></canvas>
    </div>

    <div id="commentSection">
        <h2>不具合の状況を教えてください</h2>
        <textarea id="commentInput" placeholder="例：タイムラインが表示されない" maxlength="200"></textarea>
        <button id="commentButton">コメントを投稿</button>
        <div id="commentList"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2-6vhLU9tQoSXnbVcALnBgnMZUbATFnE",
            authDomain: "twitter-status-be396.firebaseapp.com",
            databaseURL: "https://twitter-status-be396-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "twitter-status-be396",
            storageBucket: "twitter-status-be396.firebasestorage.app",
            messagingSenderId: "534805849424",
            appId: "1:534805849424:web:dc463d17c883af245ef855"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // グラフの初期化
        const ctx = document.getElementById('statusChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '不具合報告数',
                    data: [],
                    backgroundColor: 'rgba(75, 192, 192, 0.6)'
                }]
            },
options: {
    scales: {
        x: { 
ticks: { 
    maxRotation: 0, 
    minRotation: 0,
    callback: function(val, index) {
        const label = this.getLabelForValue(val);
        if (window.innerWidth < 600) {
            return (index % 6 === 0 || label === '今') ? label : '';
        }
        return label;
    }
},
    min: 12,
    max: 23
}
    },
    plugins: {
        zoom: {
            pan: { enabled: true, mode: 'x' },
            zoom: {
                wheel: { enabled: true },
                mode: 'x'
            }
        }
    }
}
        });

        // グラフをリアルタイム更新
        function updateChart() {
            const now = new Date();
            const labels = [];
            const keys = [];
            for (let i = 23; i >= 0; i--) {
                const d = new Date(now - i * 3600000);
                const key = d.getFullYear() + '-' +
                    String(d.getMonth() + 1).padStart(2, '0') + '-' +
                    String(d.getDate()).padStart(2, '0') + '-' +
                    String(d.getHours()).padStart(2, '0');
                labels.push(i === 0 ? '今' : String(d.getHours()) + '時');
                keys.push(key);
            }
            chart.data.labels = labels;
            database.ref('reports').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                chart.data.datasets[0].data = keys.map(k => data[k] || 0);
                chart.update();
            });
        }
        updateChart();

        // 不具合報告ボタン
        document.getElementById('reportButton').addEventListener('click', function () {
            if (localStorage.getItem('reported')) {
                alert('既に報告済みです！');
                return;
            }
            const now = new Date();
            const dateKey = now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0') + '-' +
                String(now.getHours()).padStart(2, '0');
            database.ref('reports/' + dateKey).transaction((current) => {
                return (current || 0) + 1;
            });
            localStorage.setItem('reported', 'true');
            alert('報告ありがとうございます！');
        });

        // コメント投稿
        document.getElementById('commentButton').addEventListener('click', function () {
    const text = document.getElementById('commentInput').value.trim();
    if (!text) return;

    const lastComment = localStorage.getItem('lastCommentTime');
    const now = Date.now();
    if (lastComment && now - lastComment < 30000) {
        const remaining = Math.ceil((30000 - (now - lastComment)) / 1000);
        alert(`あと${remaining}秒待ってください`);
        return;
    }
    localStorage.setItem('lastCommentTime', now);
            database.ref('comments').push({
                text: text,
                time: Date.now()
            });
            document.getElementById('commentInput').value = '';
        });

// コメント表示（安全版）
database.ref('comments').on('value', (snapshot) => {
    const list = document.getElementById('commentList');
    list.innerHTML = '';

    const comments = [];

    snapshot.forEach(child => {
        const val = child.val();
        if (!val || !val.text) return; // ← textが無いデータを除外
        comments.push({ key: child.key, ...val });
    });

    comments
        .sort((a, b) => (b.time || 0) - (a.time || 0))
        .slice(0, 100)
        .forEach(c => {
            const div = document.createElement('div');
            div.className = 'comment';

            const date = c.time
                ? new Date(c.time).toLocaleString('ja-JP')
                : '';

            const span = document.createElement('span');
span.className = 'comment-time';
span.textContent = date;
const p = document.createElement('p');
p.textContent = c.text;
div.appendChild(span);
div.appendChild(p);

            list.appendChild(div);
        });
});
    </script>
</body>
</html>
